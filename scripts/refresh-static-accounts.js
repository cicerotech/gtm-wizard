#!/usr/bin/env node

/**
 * Refresh Static Accounts in AccountOwnership.ts
 * 
 * Queries Salesforce with the BoB report filter (Customer Type = Existing OR open opps)
 * for all 18 business leads and regenerates the OWNERSHIP_DATA.businessLeads block
 * in obsidian-plugin/src/AccountOwnership.ts.
 * 
 * Usage:
 *   node scripts/refresh-static-accounts.js           # Dry-run: prints output
 *   node scripts/refresh-static-accounts.js --write   # Writes to AccountOwnership.ts
 * 
 * Requires: SF_USERNAME, SF_PASSWORD, SF_SECURITY_TOKEN, SF_LOGIN_URL env vars
 * (or run from the same .env as the main server)
 */

require('dotenv').config();
const jsforce = require('jsforce');
const fs = require('fs');
const path = require('path');

const TARGET_FILE = path.join(__dirname, '..', 'obsidian-plugin', 'src', 'AccountOwnership.ts');
const WRITE_MODE = process.argv.includes('--write');

// All BL emails to query
const BL_EMAILS = [
  { email: 'alex.fox@eudia.com', name: 'Alex Fox' },
  { email: 'ananth@eudia.com', name: 'Ananth Cherukupally' },
  { email: 'asad.hussain@eudia.com', name: 'Asad Hussain' },
  { email: 'conor.molloy@eudia.com', name: 'Conor Molloy' },
  { email: 'emer.flynn@eudia.com', name: 'Emer Flynn' },
  { email: 'greg.machale@eudia.com', name: 'Greg MacHale' },
  { email: 'julie.stefanich@eudia.com', name: 'Julie Stefanich' },
  { email: 'justin.hills@eudia.com', name: 'Justin Hills' },
  { email: 'keigan.pesenti@eudia.com', name: 'Keigan Pesenti' },
  { email: 'mike.masiello@eudia.com', name: 'Mike Masiello' },
  { email: 'mitchell.loquaci@eudia.com', name: 'Mitch Loquaci' },
  { email: 'nathan.shine@eudia.com', name: 'Nathan Shine' },
  { email: 'nicola.fratini@eudia.com', name: 'Nicola Fratini' },
  { email: 'olivia@eudia.com', name: 'Olivia Jung' },
  { email: 'rajeev.patel@eudia.com', name: 'Rajeev Patel' },
  { email: 'riley.stack@eudia.com', name: 'Riley Stack' },
  { email: 'sean.boyd@eudia.com', name: 'Sean Boyd' },
  { email: 'tom.clancy@eudia.com', name: 'Tom Clancy' },
];

async function main() {
  console.log('ğŸ”„ Connecting to Salesforce...');
  
  const conn = new jsforce.Connection({
    loginUrl: process.env.SF_LOGIN_URL || 'https://login.salesforce.com',
  });

  await conn.login(
    process.env.SF_USERNAME,
    process.env.SF_PASSWORD + (process.env.SF_SECURITY_TOKEN || '')
  );

  console.log('âœ… Connected to Salesforce');

  let totalAccounts = 0;
  const allBLData = [];

  for (const bl of BL_EMAILS) {
    // Resolve user ID
    const userResult = await conn.query(
      `SELECT Id FROM User WHERE Email = '${bl.email}' AND IsActive = true LIMIT 1`
    );

    if (!userResult.records || userResult.records.length === 0) {
      console.log(`âš ï¸  No active user for ${bl.email} â€” skipping`);
      allBLData.push({ ...bl, accounts: [] });
      continue;
    }

    const userId = userResult.records[0].Id;

    // Query filtered accounts (BoB report filter)
    // SOQL doesn't allow semi-join sub-selects in nested WHERE, so two queries + merge
    const existingResult = await conn.query(`
      SELECT Id, Name
      FROM Account
      WHERE OwnerId = '${userId}'
        AND Customer_Type__c = 'Existing'
        AND (NOT Name LIKE '%Sample%')
        AND (NOT Name LIKE '%Test%')
      ORDER BY Name ASC
    `);
    const oppResult = await conn.query(`
      SELECT Id, Name
      FROM Account
      WHERE OwnerId = '${userId}'
        AND Id IN (SELECT AccountId FROM Opportunity WHERE OwnerId = '${userId}' AND IsClosed = false)
        AND (NOT Name LIKE '%Sample%')
        AND (NOT Name LIKE '%Test%')
      ORDER BY Name ASC
    `);

    // Merge and deduplicate
    const seenIds = new Set();
    const accounts = [];
    for (const a of [...(existingResult.records || []), ...(oppResult.records || [])]) {
      if (!seenIds.has(a.Id)) {
        seenIds.add(a.Id);
        accounts.push({
          id: a.Id.substring(0, 15),  // 15-char ID for consistency
          name: a.Name,
        });
      }
    }
    accounts.sort((a, b) => a.name.localeCompare(b.name));

    totalAccounts += accounts.length;
    allBLData.push({ ...bl, accounts });

    console.log(`  ${bl.name} (${bl.email}): ${accounts.length} accounts`);

    // Small delay to respect rate limits
    await new Promise(r => setTimeout(r, 300));
  }

  console.log(`\nğŸ“Š Total: ${BL_EMAILS.length} BLs, ${totalAccounts} accounts`);

  // Generate TypeScript block
  const today = new Date().toISOString().split('T')[0];
  const lines = [];
  
  lines.push(`/**`);
  lines.push(` * Static mapping of business leads to their owned accounts.`);
  lines.push(` * Source: Salesforce BoB report filter (Customer Type = Existing OR Open Opps > 0)`);
  lines.push(` * Auto-generated by scripts/refresh-static-accounts.js on ${today}`);
  lines.push(` * `);
  lines.push(` * Total: ${BL_EMAILS.length} business leads, ${totalAccounts} accounts`);
  lines.push(` */`);
  lines.push(`const OWNERSHIP_DATA: AccountOwnershipData = {`);
  lines.push(`  version: '${today}',`);
  lines.push(`  lastUpdated: '${today}',`);
  lines.push(`  businessLeads: {`);

  for (const bl of allBLData) {
    lines.push(``);
    lines.push(`    // ${bl.name.toUpperCase()} (${bl.accounts.length} accounts)`);
    lines.push(`    '${bl.email}': {`);
    lines.push(`      email: '${bl.email}',`);
    lines.push(`      name: '${bl.name}',`);
    lines.push(`      accounts: [`);
    for (const a of bl.accounts) {
      const nameEscaped = a.name.replace(/'/g, "\\'");
      lines.push(`        { id: '${a.id}', name: '${nameEscaped}' },`);
    }
    lines.push(`      ]`);
    lines.push(`    },`);
  }

  lines.push(`  }`);
  lines.push(`};`);

  const generatedBlock = lines.join('\n');

  if (WRITE_MODE) {
    console.log('\nâœï¸  Writing to AccountOwnership.ts...');
    
    const content = fs.readFileSync(TARGET_FILE, 'utf-8');
    
    // Find the OWNERSHIP_DATA block boundaries
    const startMarker = /\/\*\*\s*\n\s*\* Static mapping of business leads/;
    const endMarker = /^};$/m;
    
    const startMatch = content.match(startMarker);
    if (!startMatch) {
      console.error('âŒ Could not find OWNERSHIP_DATA start marker in AccountOwnership.ts');
      process.exit(1);
    }
    
    const startIndex = content.indexOf(startMatch[0]);
    
    // Find the closing `};` after the start
    const afterStart = content.substring(startIndex);
    const constMatch = afterStart.match(/^const OWNERSHIP_DATA.*?\n/m);
    if (!constMatch) {
      console.error('âŒ Could not find const OWNERSHIP_DATA declaration');
      process.exit(1);
    }
    
    // Find the closing `};` â€” it's the first `};` on its own line after `const OWNERSHIP_DATA`
    const endMatch = afterStart.match(/^};$/m);
    if (!endMatch) {
      console.error('âŒ Could not find closing }; for OWNERSHIP_DATA');
      process.exit(1);
    }
    
    const endIndex = startIndex + endMatch.index + endMatch[0].length;
    
    const newContent = content.substring(0, startIndex) + generatedBlock + content.substring(endIndex);
    
    fs.writeFileSync(TARGET_FILE, newContent, 'utf-8');
    console.log('âœ… AccountOwnership.ts updated successfully');
  } else {
    console.log('\nğŸ“ Generated block (dry-run, use --write to apply):');
    console.log('â”€'.repeat(60));
    console.log(generatedBlock);
    console.log('â”€'.repeat(60));
  }

  await conn.logout();
  console.log('\nâœ… Done');
}

main().catch(err => {
  console.error('âŒ Error:', err.message);
  process.exit(1);
});
