var d=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var E=(r,t)=>{for(var e in t)d(r,e,{get:t[e],enumerable:!0})},F=(r,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of A(t))!v.call(r,c)&&c!==e&&d(r,c,{get:()=>t[c],enumerable:!(s=w(t,c))||s.enumerable});return r};var x=r=>F(d({},"__esModule",{value:!0}),r);var b={};E(b,{default:()=>g});module.exports=x(b);var n=require("obsidian"),T={serverUrl:"https://gtm-brain.onrender.com",accountsFolder:"Accounts",syncOnStartup:!0,lastSyncTime:null,cachedAccounts:[]},h=class extends n.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,s){let c=e.getLine(t.line),o=e.getValue(),a=e.posToOffset(t),i=o.substring(0,a),l=o.indexOf("---"),u=o.indexOf("---",l+3);if(l===-1||a<l||a>u)return null;let p=c.match(/^account:\s*(.*)$/);if(!p)return null;let y=p[1].trim(),S=c.indexOf(":")+1,m=c.substring(S).match(/^\s*/)?.[0].length||0;return{start:{line:t.line,ch:S+m},end:t,query:y}}getSuggestions(t){let e=t.query.toLowerCase(),s=this.plugin.settings.cachedAccounts;return e?s.filter(c=>c.name.toLowerCase().includes(e)).sort((c,o)=>{let a=c.name.toLowerCase().startsWith(e),i=o.name.toLowerCase().startsWith(e);return a&&!i?-1:i&&!a?1:c.name.localeCompare(o.name)}).slice(0,10):s.slice(0,10)}renderSuggestion(t,e){e.createEl("div",{text:t.name,cls:"suggestion-title"})}selectSuggestion(t,e){if(!this.context)return;this.context.editor.replaceRange(t.name,this.context.start,this.context.end)}},g=class extends n.Plugin{async onload(){await this.loadSettings(),this.accountSuggester=new h(this.app,this),this.registerEditorSuggest(this.accountSuggester),this.addRibbonIcon("refresh-cw","Sync Salesforce Accounts",async()=>{await this.syncAccounts()}),this.addCommand({id:"sync-salesforce-accounts",name:"Sync Salesforce Accounts",callback:async()=>{await this.syncAccounts()}}),this.addCommand({id:"sync-note-to-salesforce",name:"Sync Current Note to Salesforce",callback:async()=>{await this.syncNoteToSalesforce()}}),this.addCommand({id:"create-from-meeting-prep",name:"Create Note from Meeting Prep",callback:async()=>{await this.createFromMeetingPrep()}}),this.addSettingTab(new f(this.app,this)),this.settings.syncOnStartup&&setTimeout(()=>{this.syncAccounts(!0)},2e3)}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async syncAccounts(t=!1){try{t||new n.Notice("Syncing Salesforce accounts...");let e=await this.fetchAccounts();if(e.length===0){t||new n.Notice("No accounts found or server unavailable");return}this.settings.cachedAccounts=e,await this.ensureFolderExists(this.settings.accountsFolder);let s=this.getExistingAccountFolders(),c=0;for(let o of e){let a=this.sanitizeFolderName(o.name),i=`${this.settings.accountsFolder}/${a}`;s.includes(a.toLowerCase())||(await this.ensureFolderExists(i),c++)}this.settings.lastSyncTime=new Date().toISOString(),await this.saveSettings(),t||(c>0?new n.Notice(`Sync complete! Created ${c} new account folders. ${e.length} accounts available for autocomplete.`):new n.Notice(`Sync complete. All ${e.length} accounts ready for autocomplete.`))}catch(e){console.error("Eudia Sync error:",e),t||new n.Notice(`Sync failed: ${e.message}`)}}async fetchAccounts(){try{let e=(await(0,n.requestUrl)({url:`${this.settings.serverUrl}/api/accounts/obsidian`,method:"GET",headers:{Accept:"application/json"}})).json;if(!e.success)throw new Error("API returned unsuccessful response");return e.accounts||[]}catch(t){throw console.error("Failed to fetch accounts:",t),new Error("Could not connect to GTM Brain server")}}async syncNoteToSalesforce(){let t=this.app.workspace.getActiveFile();if(!t){new n.Notice("No active note to sync");return}try{let e=await this.app.vault.read(t),s=this.parseFrontmatter(e);if(!s.account){new n.Notice('No account specified in note. Add an "account" property first.');return}let c=this.settings.cachedAccounts.find(a=>a.name.toLowerCase()===s.account.toLowerCase());if(!c){new n.Notice(`Account "${s.account}" not found in Salesforce`);return}new n.Notice("Syncing note to Salesforce...");let o=await(0,n.requestUrl)({url:`${this.settings.serverUrl}/api/notes/sync`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:c.id,accountName:c.name,noteTitle:t.basename,notePath:t.path,content:e,frontmatter:s,syncedAt:new Date().toISOString()})});o.json.success?(new n.Notice("\u2713 Note synced to Salesforce"),await this.updateFrontmatter(t,{synced_to_salesforce:!0,last_synced:new Date().toISOString()})):new n.Notice(`Sync failed: ${o.json.error||"Unknown error"}`)}catch(e){console.error("Sync to Salesforce failed:",e),new n.Notice(`Sync failed: ${e.message}`)}}async createFromMeetingPrep(){try{new n.Notice("Meeting Prep integration coming soon. Use the Meeting Prep tab at gtm-brain.onrender.com for now.")}catch(t){console.error("Create from meeting prep failed:",t),new n.Notice(`Failed: ${t.message}`)}}parseFrontmatter(t){let e=t.match(/^---\n([\s\S]*?)\n---/);if(!e)return{};let s={},c=e[1].split(`
`);for(let o of c){let a=o.indexOf(":");if(a>0){let i=o.substring(0,a).trim(),l=o.substring(a+1).trim();s[i]=l}}return s}async updateFrontmatter(t,e){let s=await this.app.vault.read(t),c=s.match(/^---\n([\s\S]*?)\n---/);if(c){let o=c[1];for(let[a,i]of Object.entries(e)){let l=new RegExp(`^${a}:.*$`,"m"),u=`${a}: ${i}`;l.test(o)?o=o.replace(l,u):o+=`
${u}`}s=s.replace(/^---\n[\s\S]*?\n---/,`---
${o}
---`),await this.app.vault.modify(t,s)}}getExistingAccountFolders(){let t=this.app.vault.getAbstractFileByPath(this.settings.accountsFolder);return!t||!(t instanceof n.TFolder)?[]:t.children.filter(e=>e instanceof n.TFolder).map(e=>e.name.toLowerCase())}async ensureFolderExists(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t)}sanitizeFolderName(t){return t.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g," ").trim()}},f=class extends n.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Eudia Sync Settings"}),new n.Setting(t).setName("GTM Brain Server URL").setDesc("The URL of your GTM Brain server").addText(e=>e.setPlaceholder("https://gtm-brain.onrender.com").setValue(this.plugin.settings.serverUrl).onChange(async s=>{this.plugin.settings.serverUrl=s,await this.plugin.saveSettings()})),new n.Setting(t).setName("Accounts Folder").setDesc("Folder where account subfolders will be created").addText(e=>e.setPlaceholder("Accounts").setValue(this.plugin.settings.accountsFolder).onChange(async s=>{this.plugin.settings.accountsFolder=s||"Accounts",await this.plugin.saveSettings()})),new n.Setting(t).setName("Sync on Startup").setDesc("Automatically sync accounts when Obsidian opens").addToggle(e=>e.setValue(this.plugin.settings.syncOnStartup).onChange(async s=>{this.plugin.settings.syncOnStartup=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Status"}),this.plugin.settings.lastSyncTime){let e=new Date(this.plugin.settings.lastSyncTime);t.createEl("p",{text:`Last synced: ${e.toLocaleString()}`,cls:"setting-item-description"})}t.createEl("p",{text:`Cached accounts: ${this.plugin.settings.cachedAccounts.length}`,cls:"setting-item-description"}),new n.Setting(t).setName("Sync Now").setDesc("Manually sync Salesforce accounts").addButton(e=>e.setButtonText("Sync Accounts").setCta().onClick(async()=>{await this.plugin.syncAccounts(),this.display()})),t.createEl("h3",{text:"Salesforce Integration"}),new n.Setting(t).setName("Sync Current Note").setDesc("Push the current note's data to Salesforce").addButton(e=>e.setButtonText("Sync to Salesforce").onClick(async()=>{await this.plugin.syncNoteToSalesforce()}))}};
