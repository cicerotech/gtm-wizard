var b=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var F=(u,t)=>{for(var e in t)b(u,e,{get:t[e],enumerable:!0})},I=(u,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of P(t))!k.call(u,n)&&n!==e&&b(u,n,{get:()=>t[n],enumerable:!(s=T(t,n))||s.enumerable});return u};var $=u=>I(b({},"__esModule",{value:!0}),u);var M={};F(M,{default:()=>w});module.exports=$(M);var a=require("obsidian");var p=class{constructor(){this.mediaRecorder=null;this.audioChunks=[];this.stream=null;this.startTime=0;this.pausedDuration=0;this.pauseStartTime=0;this.durationInterval=null;this.audioContext=null;this.analyser=null;this.levelInterval=null;this.state={isRecording:!1,isPaused:!1,duration:0,audioLevel:0};this.stateCallback=null}onStateChange(t){this.stateCallback=t}getSupportedMimeType(){let t=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus","audio/ogg"];for(let e of t)if(MediaRecorder.isTypeSupported(e))return e;return"audio/webm"}async startRecording(){if(this.state.isRecording)throw new Error("Already recording");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}}),this.setupAudioAnalysis();let t=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:t,audioBitsPerSecond:48e3}),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.start(1e3),this.startTime=Date.now(),this.pausedDuration=0,this.state={isRecording:!0,isPaused:!1,duration:0,audioLevel:0},this.startDurationTracking(),this.startLevelTracking(),this.notifyStateChange()}catch(t){throw this.cleanup(),new Error(`Failed to start recording: ${t.message}`)}}setupAudioAnalysis(){if(this.stream)try{this.audioContext=new AudioContext;let t=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,t.connect(this.analyser)}catch(t){console.warn("Failed to set up audio analysis:",t)}}startDurationTracking(){this.durationInterval=setInterval(()=>{if(this.state.isRecording&&!this.state.isPaused){let t=Date.now()-this.startTime-this.pausedDuration;this.state.duration=Math.floor(t/1e3),this.notifyStateChange()}},100)}startLevelTracking(){if(!this.analyser)return;let t=new Uint8Array(this.analyser.frequencyBinCount);this.levelInterval=setInterval(()=>{if(this.state.isRecording&&!this.state.isPaused&&this.analyser){this.analyser.getByteFrequencyData(t);let e=0;for(let n=0;n<t.length;n++)e+=t[n];let s=e/t.length;this.state.audioLevel=Math.min(100,Math.round(s/255*100*2)),this.notifyStateChange()}},50)}pauseRecording(){!this.state.isRecording||this.state.isPaused||this.mediaRecorder&&this.mediaRecorder.state==="recording"&&(this.mediaRecorder.pause(),this.pauseStartTime=Date.now(),this.state.isPaused=!0,this.notifyStateChange())}resumeRecording(){!this.state.isRecording||!this.state.isPaused||this.mediaRecorder&&this.mediaRecorder.state==="paused"&&(this.mediaRecorder.resume(),this.pausedDuration+=Date.now()-this.pauseStartTime,this.state.isPaused=!1,this.notifyStateChange())}async stopRecording(){return new Promise((t,e)=>{if(!this.mediaRecorder||!this.state.isRecording){e(new Error("Not currently recording"));return}let s=this.mediaRecorder.mimeType,n=this.state.duration;this.mediaRecorder.onstop=()=>{try{let i=new Blob(this.audioChunks,{type:s}),r=new Date,o=r.toISOString().split("T")[0],l=r.toTimeString().split(" ")[0].replace(/:/g,"-"),c=s.includes("webm")?"webm":s.includes("mp4")?"m4a":s.includes("ogg")?"ogg":"webm",d=`recording-${o}-${l}.${c}`;this.cleanup(),t({audioBlob:i,duration:n,mimeType:s,filename:d})}catch(i){this.cleanup(),e(i)}},this.mediaRecorder.onerror=i=>{this.cleanup(),e(new Error("Recording error occurred"))},this.mediaRecorder.stop()})}cancelRecording(){this.cleanup()}cleanup(){this.durationInterval&&(clearInterval(this.durationInterval),this.durationInterval=null),this.levelInterval&&(clearInterval(this.levelInterval),this.levelInterval=null),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null,this.analyser=null),this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],this.state={isRecording:!1,isPaused:!1,duration:0,audioLevel:0},this.notifyStateChange()}getState(){return{...this.state}}static isSupported(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}notifyStateChange(){this.stateCallback&&this.stateCallback({...this.state})}static formatDuration(t){let e=Math.floor(t/60),s=t%60;return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}static async blobToBase64(t){return new Promise((e,s)=>{let n=new FileReader;n.onload=()=>{let r=n.result.split(",")[1];e(r)},n.onerror=s,n.readAsDataURL(t)})}static async blobToArrayBuffer(t){return t.arrayBuffer()}};var y=require("obsidian"),m=class{constructor(t,e){this.openaiApiKey=null;this.serverUrl=t,this.openaiApiKey=e||null}setServerUrl(t){this.serverUrl=t}setOpenAIKey(t){this.openaiApiKey=t}async transcribeAndSummarize(t,e,s,n,i){try{let r=await(0,y.requestUrl)({url:`${this.serverUrl}/api/transcribe-and-summarize`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio:t,mimeType:e,accountName:s,accountId:n,openaiApiKey:this.openaiApiKey,context:i?{customerBrain:i.account?.customerBrain,opportunities:i.opportunities,contacts:i.contacts}:void 0})});return r.json.success?{success:!0,transcript:r.json.transcript||"",sections:r.json.sections||this.getEmptySections(),duration:r.json.duration||0}:r.json.error?.includes("OpenAI not initialized")&&this.openaiApiKey?(console.log("Server OpenAI unavailable, trying local fallback..."),this.transcribeLocal(t,e,s)):{success:!1,transcript:"",sections:this.getEmptySections(),duration:0,error:r.json.error||"Transcription failed"}}catch(r){return console.error("Server transcription error:",r),this.openaiApiKey?(console.log("Server unreachable, trying local OpenAI fallback..."),this.transcribeLocal(t,e,s)):{success:!1,transcript:"",sections:this.getEmptySections(),duration:0,error:`Server unavailable: ${r.message}. Add OpenAI API key in settings for offline mode.`}}}async transcribeLocal(t,e,s){if(!this.openaiApiKey)return{success:!1,transcript:"",sections:this.getEmptySections(),duration:0,error:"No OpenAI API key configured. Add it in plugin settings."};try{let n=atob(t),i=new Uint8Array(n.length);for(let g=0;g<n.length;g++)i[g]=n.charCodeAt(g);let r=new Blob([i],{type:e}),o=new FormData,l=e.includes("webm")?"webm":e.includes("mp4")?"m4a":"ogg";o.append("file",r,`audio.${l}`),o.append("model","whisper-1"),o.append("response_format","verbose_json"),o.append("language","en");let c=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.openaiApiKey}`},body:o});if(!c.ok){let g=await c.text();throw new Error(`Whisper API error: ${c.status} - ${g}`)}let d=await c.json(),h=d.text||"",f=d.duration||0,R=await this.summarizeLocal(h,s);return{success:!0,transcript:h,sections:R,duration:f}}catch(n){return console.error("Local transcription error:",n),{success:!1,transcript:"",sections:this.getEmptySections(),duration:0,error:n.message||"Local transcription failed"}}}async summarizeLocal(t,e){if(!this.openaiApiKey)return this.getEmptySections();try{let s=`You are a sales intelligence analyst. Extract structured insights from this meeting transcript.

${e?`Account: ${e}`:""}

Provide output with these sections (use ## headers):
## Summary - 3-5 bullet points of key takeaways
## Key Stakeholders - People mentioned with roles
## MEDDICC Signals - Economic Buyer, Decision Process, Champion, Pain, Competition
## Product Interest - Products discussed
## Key Dates - Deadlines and timelines
## Next Steps - Agreed actions as checkboxes
## Action Items - Internal follow-ups as checkboxes
## Deal Signals - Stage progression/regression indicators
## Risks & Objections - Concerns raised

Be specific, quote when helpful. If a section has no content, say so.`,n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${this.openaiApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o",messages:[{role:"system",content:s},{role:"user",content:`Analyze this transcript:

${t.substring(0,1e5)}`}],temperature:.3,max_tokens:4e3})});if(!n.ok)return console.warn("GPT summarization failed, returning empty sections"),this.getEmptySections();let r=(await n.json()).choices?.[0]?.message?.content||"";return this.parseSections(r)}catch(s){return console.error("Local summarization error:",s),this.getEmptySections()}}parseSections(t){let e={summary:"",keyStakeholders:"",meddiccSignals:"",productInterest:"",keyDates:"",nextSteps:"",actionItems:"",dealSignals:"",risksObjections:""},s={summary:"summary","key stakeholders":"keyStakeholders","meddicc signals":"meddiccSignals","product interest":"productInterest","key dates":"keyDates","next steps":"nextSteps","action items":"actionItems","deal signals":"dealSignals","risks & objections":"risksObjections","risks and objections":"risksObjections"},n=/## ([^\n]+)\n([\s\S]*?)(?=## |$)/g,i;for(;(i=n.exec(t))!==null;){let r=i[1].trim().toLowerCase(),o=i[2].trim(),l=s[r];l&&(e[l]=o)}return e}async getMeetingContext(t){try{let e=await(0,y.requestUrl)({url:`${this.serverUrl}/api/meeting-context/${t}`,method:"GET",headers:{Accept:"application/json"}});return e.json.success?{success:!0,account:e.json.account,opportunities:e.json.opportunities,contacts:e.json.contacts,lastMeeting:e.json.lastMeeting}:{success:!1,error:e.json.error||"Failed to fetch context"}}catch(e){return console.error("Meeting context error:",e),{success:!1,error:e.message||"Network error"}}}async syncToSalesforce(t,e,s,n,i,r){try{let o=await(0,y.requestUrl)({url:`${this.serverUrl}/api/transcription/sync-to-salesforce`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:t,accountName:e,noteTitle:s,sections:n,transcript:i,meetingDate:r||new Date().toISOString(),syncedAt:new Date().toISOString()})});return o.json.success?{success:!0,customerBrainUpdated:o.json.customerBrainUpdated,eventCreated:o.json.eventCreated,eventId:o.json.eventId,contactsCreated:o.json.contactsCreated,tasksCreated:o.json.tasksCreated}:{success:!1,error:o.json.error||"Sync failed"}}catch(o){return console.error("Salesforce sync error:",o),{success:!1,error:o.message||"Network error"}}}getEmptySections(){return{summary:"",keyStakeholders:"",meddiccSignals:"",productInterest:"",keyDates:"",nextSteps:"",actionItems:""}}static formatSectionsForNote(t,e){let s="";return t.summary&&(s+=`## Summary

${t.summary}

`),t.keyStakeholders&&(s+=`## Key Stakeholders

${t.keyStakeholders}

`),t.meddiccSignals&&(s+=`## MEDDICC Signals

${t.meddiccSignals}

`),t.productInterest&&(s+=`## Product Interest

${t.productInterest}

`),t.keyDates&&(s+=`## Key Dates

${t.keyDates}

`),t.nextSteps&&(s+=`## Next Steps

${t.nextSteps}

`),t.actionItems&&(s+=`## Action Items

${t.actionItems}

`),t.dealSignals&&(s+=`## Deal Signals

${t.dealSignals}

`),t.risksObjections&&(s+=`## Risks & Objections

${t.risksObjections}

`),t.competitiveIntel&&(s+=`## Competitive Intelligence

${t.competitiveIntel}

`),e&&(s+=`---

## Full Transcript

${e}
`),s}static formatSectionsWithAudio(t,e,s){let n=this.formatSectionsForNote(t,e);return s&&(n+=`
---

## Recording

![[${s}]]
`),n}static formatContextForNote(t){if(!t.success)return"";let e=`## Pre-Call Context

`;if(t.account&&(e+=`**Account:** ${t.account.name}
`,e+=`**Owner:** ${t.account.owner}

`),t.opportunities&&t.opportunities.length>0){e+=`### Open Opportunities

`;for(let s of t.opportunities){let n=s.acv?`$${(s.acv/1e3).toFixed(0)}k`:"TBD";e+=`- **${s.name}** - ${s.stage} - ${n}`,s.targetSignDate&&(e+=` - Target: ${new Date(s.targetSignDate).toLocaleDateString()}`),e+=`
`}e+=`
`}if(t.contacts&&t.contacts.length>0){e+=`### Key Contacts

`;for(let s of t.contacts.slice(0,5))e+=`- **${s.name}**`,s.title&&(e+=` - ${s.title}`),e+=`
`;e+=`
`}if(t.lastMeeting&&(e+=`### Last Meeting

`,e+=`${new Date(t.lastMeeting.date).toLocaleDateString()} - ${t.lastMeeting.subject}

`),t.account?.customerBrain){let s=t.account.customerBrain.substring(0,500);s&&(e+=`### Recent Notes

`,e+=`${s}${t.account.customerBrain.length>500?"...":""}

`)}return e+=`---

`,e}};var B={serverUrl:"https://gtm-brain.onrender.com",accountsFolder:"Accounts",recordingsFolder:"Recordings",syncOnStartup:!0,autoSyncAfterTranscription:!0,saveAudioFiles:!0,appendTranscript:!1,lastSyncTime:null,cachedAccounts:[],userEmail:"",setupCompleted:!1,calendarConfigured:!1,openaiApiKey:""},E=class extends a.EditorSuggest{constructor(t,e){super(t),this.plugin=e}onTrigger(t,e,s){let n=e.getLine(t.line),i=e.getValue(),r=e.posToOffset(t),o=i.indexOf("---"),l=i.indexOf("---",o+3);if(o===-1||r<o||r>l)return null;let c=n.match(/^account:\s*(.*)$/);if(!c)return null;let d=c[1].trim(),h=n.indexOf(":")+1,f=n.substring(h).match(/^\s*/)?.[0].length||0;return{start:{line:t.line,ch:h+f},end:t,query:d}}getSuggestions(t){let e=t.query.toLowerCase(),s=this.plugin.settings.cachedAccounts;return e?s.filter(n=>n.name.toLowerCase().includes(e)).sort((n,i)=>{let r=n.name.toLowerCase().startsWith(e),o=i.name.toLowerCase().startsWith(e);return r&&!o?-1:o&&!r?1:n.name.localeCompare(i.name)}).slice(0,10):s.slice(0,10)}renderSuggestion(t,e){e.createEl("div",{text:t.name,cls:"suggestion-title"})}selectSuggestion(t,e){if(!this.context)return;this.context.editor.replaceRange(t.name,this.context.start,this.context.end)}},C=class{constructor(t,e,s,n){this.containerEl=null;this.durationEl=null;this.levelBarEl=null;this.statusTextEl=null;this.onPause=t,this.onResume=e,this.onStop=s,this.onCancel=n}show(){if(this.containerEl)return;this.containerEl=document.createElement("div"),this.containerEl.className="eudia-recording-bar recording";let t=document.createElement("div");t.className="eudia-recording-indicator",this.containerEl.appendChild(t),this.durationEl=document.createElement("div"),this.durationEl.className="eudia-duration",this.durationEl.textContent="00:00",this.containerEl.appendChild(this.durationEl);let e=document.createElement("div");e.className="eudia-level-container",this.levelBarEl=document.createElement("div"),this.levelBarEl.className="eudia-level-bar",this.levelBarEl.style.width="0%",e.appendChild(this.levelBarEl),this.containerEl.appendChild(e),this.statusTextEl=document.createElement("div"),this.statusTextEl.className="eudia-status-text",this.statusTextEl.textContent="Recording...",this.containerEl.appendChild(this.statusTextEl);let s=document.createElement("div");s.className="eudia-controls";let n=document.createElement("button");n.className="eudia-control-btn pause",n.innerHTML="\u23F8",n.title="Pause",n.onclick=()=>this.onPause(),s.appendChild(n);let i=document.createElement("button");i.className="eudia-control-btn stop",i.innerHTML="\u23F9",i.title="Stop & Transcribe",i.onclick=()=>this.onStop(),s.appendChild(i);let r=document.createElement("button");r.className="eudia-control-btn cancel",r.innerHTML="\u2715",r.title="Cancel",r.onclick=()=>this.onCancel(),s.appendChild(r),this.containerEl.appendChild(s),document.body.appendChild(this.containerEl)}hide(){this.containerEl&&(this.containerEl.remove(),this.containerEl=null)}updateState(t){this.containerEl&&(this.durationEl&&(this.durationEl.textContent=p.formatDuration(t.duration)),this.levelBarEl&&(this.levelBarEl.style.width=`${t.audioLevel}%`),t.isPaused?(this.containerEl.className="eudia-recording-bar paused",this.statusTextEl&&(this.statusTextEl.textContent="Paused")):(this.containerEl.className="eudia-recording-bar recording",this.statusTextEl&&(this.statusTextEl.textContent="Recording...")))}setProcessing(){if(!this.containerEl)return;this.containerEl.className="eudia-recording-bar processing",this.statusTextEl&&(this.statusTextEl.textContent="Transcribing..."),this.containerEl.querySelectorAll("button").forEach(e=>e.setAttribute("disabled","true"))}},x=class extends a.Modal{constructor(t){super(t)}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("eudia-transcribing-modal");let e=t.createDiv({cls:"spinner"});this.messageEl=t.createEl("p",{text:"Transcribing audio..."}),t.createEl("p",{text:"This may take a moment for longer recordings."})}setMessage(t){this.messageEl&&(this.messageEl.textContent=t)}onClose(){let{contentEl:t}=this;t.empty()}},S=class extends a.Modal{constructor(t,e,s){super(t),this.plugin=e,this.onSelect=s}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("eudia-account-selector"),t.createEl("h3",{text:"Select Account for Meeting Note"}),this.searchInput=t.createEl("input",{type:"text",placeholder:"Search accounts..."}),this.searchInput.style.width="100%",this.searchInput.style.padding="10px",this.searchInput.style.marginBottom="10px",this.searchInput.style.borderRadius="6px",this.searchInput.style.border="1px solid var(--background-modifier-border)",this.resultsContainer=t.createDiv({cls:"eudia-account-results"}),this.resultsContainer.style.maxHeight="300px",this.resultsContainer.style.overflowY="auto",this.updateResults(""),this.searchInput.addEventListener("input",()=>{this.updateResults(this.searchInput.value)}),this.searchInput.focus()}updateResults(t){this.resultsContainer.empty();let e=this.plugin.settings.cachedAccounts,s=t.toLowerCase(),n=t?e.filter(i=>i.name.toLowerCase().includes(s)):e.slice(0,20);if(n.length===0){this.resultsContainer.createEl("div",{text:t?"No accounts found":'No accounts cached. Run "Sync Accounts" first.',cls:"eudia-no-results"}).style.padding="10px";return}for(let i of n.slice(0,20)){let r=this.resultsContainer.createEl("div",{cls:"eudia-account-item"});r.style.padding="8px 12px",r.style.cursor="pointer",r.style.borderRadius="4px",r.createEl("span",{text:i.name}),r.addEventListener("mouseenter",()=>{r.style.background="var(--background-modifier-hover)"}),r.addEventListener("mouseleave",()=>{r.style.background=""}),r.addEventListener("click",()=>{this.onSelect(i),this.close()})}}onClose(){let{contentEl:t}=this;t.empty()}},v=class extends a.Modal{constructor(t,e,s){super(t),this.plugin=e,this.onComplete=s}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("eudia-setup-wizard"),t.createEl("h2",{text:"\u{1F44B} Welcome to Eudia Sales Intelligence"}),t.createEl("p",{text:"Quick setup to get you recording meetings and syncing to Salesforce.",cls:"setting-item-description"});let e=t.createDiv({cls:"eudia-setup-section"});e.createEl("h3",{text:"1. Enter Your Email"}),e.createEl("p",{text:"Your Eudia work email (used for calendar sync)",cls:"setting-item-description"}),this.emailInput=e.createEl("input",{type:"email",placeholder:"yourname@eudia.com",cls:"eudia-email-input"}),this.emailInput.style.width="100%",this.emailInput.style.padding="8px 12px",this.emailInput.style.marginTop="8px",this.emailInput.style.borderRadius="6px",this.emailInput.style.border="1px solid var(--background-modifier-border)";let s=t.createDiv({cls:"eudia-setup-section"});s.style.marginTop="20px",s.createEl("h3",{text:"2. What Gets Configured"});let n=s.createEl("ul");n.style.fontSize="13px",n.style.color="var(--text-muted)",["\u{1F4C1} Salesforce account folders synced","\u{1F4C5} Your calendar connected (for meeting context)","\u{1F399}\uFE0F Recording \u2192 Transcription \u2192 Summary ready","\u2601\uFE0F Auto-sync to Salesforce Customer Brain"].forEach(c=>n.createEl("li",{text:c})),this.statusEl=t.createDiv({cls:"eudia-setup-status"}),this.statusEl.style.marginTop="16px",this.statusEl.style.padding="12px",this.statusEl.style.borderRadius="8px",this.statusEl.style.display="none";let r=t.createDiv({cls:"eudia-setup-buttons"});r.style.marginTop="24px",r.style.display="flex",r.style.justifyContent="flex-end",r.style.gap="12px";let o=r.createEl("button",{text:"Skip for Now"});o.onclick=()=>this.close();let l=r.createEl("button",{text:"Complete Setup",cls:"mod-cta"});l.onclick=()=>this.runSetup()}async runSetup(){let t=this.emailInput.value.trim().toLowerCase();if(!t||!t.includes("@")){this.showStatus("Please enter a valid email address","error");return}this.showStatus("Setting up...","info");try{this.plugin.settings.userEmail=t,await this.plugin.saveSettings(),this.showStatus("Syncing Salesforce accounts...","info"),await this.plugin.syncAccounts(!0),this.showStatus("Configuring calendar...","info"),await this.configureCalendar(t),this.plugin.settings.setupCompleted=!0,await this.plugin.saveSettings(),this.showStatus("\u2713 Setup complete! You're ready to record meetings.","success"),setTimeout(()=>{this.close(),this.onComplete(),new a.Notice("\u{1F389} Eudia Scribe is ready! Click the mic icon to record.")},1500)}catch(e){this.showStatus(`Setup failed: ${e.message}`,"error")}}async configureCalendar(t){try{let e=".obsidian/plugins/full-calendar/data.json",s=this.app.vault.getAbstractFileByPath(e),i={defaultCalendar:0,recursiveLocal:!1,calendars:[{type:"ical",name:"Work Calendar",url:`${this.plugin.settings.serverUrl}/api/calendar/${t}/feed.ics`,color:"#8e99e1"}],firstDay:0,initialView:{desktop:"timeGridWeek",mobile:"timeGrid3Days"}};s&&s instanceof a.TFile?await this.app.vault.modify(s,JSON.stringify(i,null,2)):(this.app.vault.getAbstractFileByPath(".obsidian/plugins/full-calendar")||await this.app.vault.createFolder(".obsidian/plugins/full-calendar"),await this.app.vault.create(e,JSON.stringify(i,null,2))),this.plugin.settings.calendarConfigured=!0}catch(e){console.warn("Could not configure Full Calendar:",e)}}showStatus(t,e){this.statusEl.style.display="block",this.statusEl.textContent=t,e==="success"?(this.statusEl.style.background="var(--background-modifier-success)",this.statusEl.style.color="var(--text-success)"):e==="error"?(this.statusEl.style.background="var(--background-modifier-error)",this.statusEl.style.color="var(--text-error)"):(this.statusEl.style.background="var(--background-secondary)",this.statusEl.style.color="var(--text-muted)")}onClose(){let{contentEl:t}=this;t.empty()}},w=class extends a.Plugin{constructor(){super(...arguments);this.recordingStatusBar=null;this.ribbonIcon=null;this.isRecording=!1;this.isPaused=!1}async onload(){await this.loadSettings(),this.audioRecorder=new p,this.transcriptionService=new m(this.settings.serverUrl,this.settings.openaiApiKey),this.audioRecorder.onStateChange(e=>{this.recordingStatusBar&&this.recordingStatusBar.updateState(e)}),this.accountSuggester=new E(this.app,this),this.registerEditorSuggest(this.accountSuggester),this.ribbonIcon=this.addRibbonIcon("microphone","Record Meeting",async()=>{await this.toggleRecording()}),this.addRibbonIcon("refresh-cw","Sync Salesforce Accounts",async()=>{await this.syncAccounts()}),this.addCommand({id:"start-recording",name:"Start Recording",callback:async()=>{this.isRecording||await this.startRecording()}}),this.addCommand({id:"stop-recording",name:"Stop Recording & Transcribe",callback:async()=>{this.isRecording&&await this.stopRecording()}}),this.addCommand({id:"toggle-recording",name:"Toggle Recording",callback:async()=>{await this.toggleRecording()}}),this.addCommand({id:"pause-recording",name:"Pause/Resume Recording",callback:()=>{this.isRecording&&this.togglePause()}}),this.addCommand({id:"sync-salesforce-accounts",name:"Sync Salesforce Accounts",callback:async()=>{await this.syncAccounts()}}),this.addCommand({id:"sync-note-to-salesforce",name:"Sync Current Note to Salesforce",callback:async()=>{await this.syncNoteToSalesforce()}}),this.addCommand({id:"fetch-meeting-context",name:"Fetch Pre-Call Context",callback:async()=>{await this.fetchAndInsertContext()}}),this.addCommand({id:"create-meeting-note",name:"Create New Meeting Note",callback:async()=>{await this.createMeetingNote()}}),this.registerEvent(this.app.vault.on("create",async e=>{e instanceof a.TFile&&e.extension==="md"&&e.path.startsWith(this.settings.accountsFolder+"/")&&(await this.app.vault.read(e)).trim()===""&&await this.applyMeetingTemplate(e)})),this.addSettingTab(new A(this.app,this)),this.addCommand({id:"run-setup-wizard",name:"Run Setup Wizard",callback:()=>{new v(this.app,this,()=>{}).open()}}),this.settings.setupCompleted?this.settings.syncOnStartup&&setTimeout(()=>{this.syncAccounts(!0)},2e3):setTimeout(()=>{new v(this.app,this,()=>{this.syncAccounts(!0)}).open()},1500)}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.transcriptionService&&(this.transcriptionService.setServerUrl(this.settings.serverUrl),this.transcriptionService.setOpenAIKey(this.settings.openaiApiKey))}async toggleRecording(){this.isRecording?await this.stopRecording():await this.startRecording()}async startRecording(){if(this.isRecording)return;if(!p.isSupported()){new a.Notice("Audio recording is not supported in this browser");return}if(!this.app.workspace.getActiveFile()){new a.Notice("Please open or create a note first");return}try{await this.audioRecorder.startRecording(),this.isRecording=!0,this.isPaused=!1,this.ribbonIcon&&this.ribbonIcon.addClass("eudia-ribbon-recording"),this.recordingStatusBar=new C(()=>this.togglePause(),()=>this.togglePause(),()=>this.stopRecording(),()=>this.cancelRecording()),this.recordingStatusBar.show(),new a.Notice("Recording started")}catch(s){new a.Notice(`Failed to start recording: ${s.message}`),this.isRecording=!1}}async stopRecording(){if(this.isRecording)try{this.recordingStatusBar&&this.recordingStatusBar.setProcessing();let e=await this.audioRecorder.stopRecording();this.isRecording=!1,this.isPaused=!1,this.recordingStatusBar&&(this.recordingStatusBar.hide(),this.recordingStatusBar=null),this.ribbonIcon&&this.ribbonIcon.removeClass("eudia-ribbon-recording");let s=new x(this.app);s.open();try{await this.processRecording(e,s),s.close(),new a.Notice("Transcription complete!")}catch(n){s.close(),new a.Notice(`Transcription failed: ${n.message}`)}}catch(e){this.isRecording=!1,this.recordingStatusBar&&(this.recordingStatusBar.hide(),this.recordingStatusBar=null),this.ribbonIcon&&this.ribbonIcon.removeClass("eudia-ribbon-recording"),new a.Notice(`Error stopping recording: ${e.message}`)}}togglePause(){this.isRecording&&(this.isPaused?(this.audioRecorder.resumeRecording(),this.isPaused=!1):(this.audioRecorder.pauseRecording(),this.isPaused=!0))}cancelRecording(){this.isRecording&&(this.audioRecorder.cancelRecording(),this.isRecording=!1,this.isPaused=!1,this.recordingStatusBar&&(this.recordingStatusBar.hide(),this.recordingStatusBar=null),this.ribbonIcon&&this.ribbonIcon.removeClass("eudia-ribbon-recording"),new a.Notice("Recording cancelled"))}async processRecording(e,s){let n=this.app.workspace.getActiveFile();if(!n)throw new Error("No active file");let i=this.detectAccountFromPath(n.path),r;i&&(s.setMessage("Fetching account context..."),r=await this.transcriptionService.getMeetingContext(i.id)),s.setMessage("Preparing audio...");let o=await p.blobToBase64(e.audioBlob),l;this.settings.saveAudioFiles&&(s.setMessage("Saving audio file..."),l=await this.saveAudioFile(e,n)),s.setMessage("Transcribing audio...");let c=await this.transcriptionService.transcribeAndSummarize(o,e.mimeType,i?.name,i?.id,r);if(!c.success)throw new Error(c.error||"Transcription failed");s.setMessage("Updating note..."),await this.insertTranscriptionResults(n,c,l),this.settings.autoSyncAfterTranscription&&i&&(s.setMessage("Syncing to Salesforce..."),await this.transcriptionService.syncToSalesforce(i.id,i.name,n.basename,c.sections,c.transcript))}detectAccountFromPath(e){let s=this.settings.accountsFolder;if(!e.startsWith(s+"/"))return null;let i=e.substring(s.length+1).split("/")[0];return i&&this.settings.cachedAccounts.find(o=>this.sanitizeFolderName(o.name).toLowerCase()===i.toLowerCase())||null}async saveAudioFile(e,s){try{await this.ensureFolderExists(this.settings.recordingsFolder);let n=`${s.basename}-${e.filename}`,i=`${this.settings.recordingsFolder}/${n}`,r=await p.blobToArrayBuffer(e.audioBlob);return await this.app.vault.createBinary(i,r),n}catch(n){console.warn("Failed to save audio file:",n);return}}async insertTranscriptionResults(e,s,n){let i=await this.app.vault.read(e),r=m.formatSectionsWithAudio(s.sections,this.settings.appendTranscript?s.transcript:void 0,n),o=i.match(/^---\n[\s\S]*?\n---\n/),l=i.match(/^(---\n[\s\S]*?\n---\n)?# [^\n]+\n/);if(l){let c=l[0].length;i=i.substring(0,c)+`
`+r+i.substring(c)}else if(o){let c=o[0].length;i=i.substring(0,c)+`
`+r+i.substring(c)}else i=r+i;await this.app.vault.modify(e,i),await this.updateFrontmatter(e,{transcribed:!0,transcribed_at:new Date().toISOString()})}async createMeetingNote(){new S(this.app,this,async e=>{if(!e){new a.Notice("No account selected");return}let n=new Date().toISOString().split("T")[0],i=`${n} Meeting.md`,r=`${this.settings.accountsFolder}/${this.sanitizeFolderName(e.name)}`;await this.ensureFolderExists(r);let o=`${r}/${i}`,l=this.app.vault.getAbstractFileByPath(o);if(l){await this.app.workspace.getLeaf().openFile(l);return}let c=this.getMeetingTemplate(e.name,n),d=await this.app.vault.create(o,c);await this.app.workspace.getLeaf().openFile(d),new a.Notice(`Created meeting note for ${e.name}`)}).open()}async applyMeetingTemplate(e){let s=this.detectAccountFromPath(e.path);if(!s)return;let n=new Date().toISOString().split("T")[0],i=this.getMeetingTemplate(s.name,n);await this.app.vault.modify(e,i)}getMeetingTemplate(e,s){return`---
title: Meeting with ${e}
date: ${s}
attendees: 
tags: meeting
account: ${e}
sync_to_salesforce: true
---

# Meeting with ${e}

## Agenda
- 

## Notes

*Click the ðŸŽ™ï¸ mic icon to start recording, or take notes manually below.*

---

`}async fetchAndInsertContext(){let e=this.app.workspace.getActiveFile();if(!e){new a.Notice("No active note");return}let s=this.detectAccountFromPath(e.path);if(!s){new a.Notice("Could not detect account from folder path");return}new a.Notice("Fetching meeting context...");let n=await this.transcriptionService.getMeetingContext(s.id);if(!n.success){new a.Notice(`Failed to fetch context: ${n.error}`);return}let i=m.formatContextForNote(n),r=await this.app.vault.read(e),o=r.match(/^(---\n[\s\S]*?\n---\n)?# [^\n]+\n/);if(o){let l=o[0].length;r=r.substring(0,l)+`
`+i+r.substring(l)}else r=i+r;await this.app.vault.modify(e,r),new a.Notice("Meeting context added")}async syncAccounts(e=!1){try{e||new a.Notice("Syncing Salesforce accounts...");let s=await this.fetchAccounts();if(s.length===0){e||new a.Notice("No accounts found or server unavailable");return}this.settings.cachedAccounts=s,await this.ensureFolderExists(this.settings.accountsFolder);let n=this.getExistingAccountFolders(),i=0;for(let r of s){let o=this.sanitizeFolderName(r.name),l=`${this.settings.accountsFolder}/${o}`;n.includes(o.toLowerCase())||(await this.ensureFolderExists(l),i++)}this.settings.lastSyncTime=new Date().toISOString(),await this.saveSettings(),e||(i>0?new a.Notice(`Sync complete! Created ${i} new account folders. ${s.length} accounts available for autocomplete.`):new a.Notice(`Sync complete. All ${s.length} accounts ready for autocomplete.`))}catch(s){console.error("Eudia Sync error:",s),e||new a.Notice(`Sync failed: ${s.message}`)}}async fetchAccounts(){try{let s=(await(0,a.requestUrl)({url:`${this.settings.serverUrl}/api/accounts/obsidian`,method:"GET",headers:{Accept:"application/json"}})).json;if(!s.success)throw new Error("API returned unsuccessful response");return s.accounts||[]}catch(e){throw console.error("Failed to fetch accounts:",e),new Error("Could not connect to GTM Brain server")}}async syncNoteToSalesforce(){let e=this.app.workspace.getActiveFile();if(!e){new a.Notice("No active note to sync");return}try{let s=await this.app.vault.read(e),n=this.parseFrontmatter(s),i=null;if(n.account&&(i=this.settings.cachedAccounts.find(o=>o.name.toLowerCase()===n.account.toLowerCase())||null),i||(i=this.detectAccountFromPath(e.path)),!i){new a.Notice('No account found. Add an "account" property or move note to an account folder.',5e3),new S(this.app,this,async o=>{o&&(await this.updateFrontmatter(e,{account:o.name}),new a.Notice(`Account set to ${o.name}. Try syncing again.`))}).open();return}new a.Notice("Syncing note to Salesforce...");let r=await(0,a.requestUrl)({url:`${this.settings.serverUrl}/api/notes/sync`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:i.id,accountName:i.name,noteTitle:e.basename,notePath:e.path,content:s,frontmatter:n,syncedAt:new Date().toISOString()})});r.json.success?(new a.Notice("\u2713 Note synced to Salesforce"),await this.updateFrontmatter(e,{synced_to_salesforce:!0,last_synced:new Date().toISOString()})):new a.Notice(`Sync failed: ${r.json.error||"Unknown error"}`)}catch(s){console.error("Sync to Salesforce failed:",s),new a.Notice(`Sync failed: ${s.message}`)}}parseFrontmatter(e){let s=e.match(/^---\n([\s\S]*?)\n---/);if(!s)return{};let n={},i=s[1].split(`
`);for(let r of i){let o=r.indexOf(":");if(o>0){let l=r.substring(0,o).trim(),c=r.substring(o+1).trim();n[l]=c}}return n}async updateFrontmatter(e,s){let n=await this.app.vault.read(e),i=n.match(/^---\n([\s\S]*?)\n---/);if(i){let r=i[1];for(let[o,l]of Object.entries(s)){let c=new RegExp(`^${o}:.*$`,"m"),d=`${o}: ${l}`;c.test(r)?r=r.replace(c,d):r+=`
${d}`}n=n.replace(/^---\n[\s\S]*?\n---/,`---
${r}
---`),await this.app.vault.modify(e,n)}}getExistingAccountFolders(){let e=this.app.vault.getAbstractFileByPath(this.settings.accountsFolder);return!e||!(e instanceof a.TFolder)?[]:e.children.filter(s=>s instanceof a.TFolder).map(s=>s.name.toLowerCase())}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}sanitizeFolderName(e){return e.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g," ").trim()}},A=class extends a.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Eudia Sync & Scribe Settings"}),t.createEl("h3",{text:"Connection"}),new a.Setting(t).setName("GTM Brain Server URL").setDesc("The URL of your GTM Brain server").addText(s=>s.setPlaceholder("https://gtm-brain.onrender.com").setValue(this.plugin.settings.serverUrl).onChange(async n=>{this.plugin.settings.serverUrl=n,await this.plugin.saveSettings()})),new a.Setting(t).setName("OpenAI API Key").setDesc("Your OpenAI API key for transcription. Required if server is unavailable.").addText(s=>{s.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async n=>{this.plugin.settings.openaiApiKey=n,await this.plugin.saveSettings()}),s.inputEl.type="password",s.inputEl.style.width="300px"}),t.createEl("h3",{text:"Folders"}),new a.Setting(t).setName("Accounts Folder").setDesc("Folder where account subfolders will be created").addText(s=>s.setPlaceholder("Accounts").setValue(this.plugin.settings.accountsFolder).onChange(async n=>{this.plugin.settings.accountsFolder=n||"Accounts",await this.plugin.saveSettings()})),new a.Setting(t).setName("Recordings Folder").setDesc("Folder where audio recordings will be saved").addText(s=>s.setPlaceholder("Recordings").setValue(this.plugin.settings.recordingsFolder).onChange(async n=>{this.plugin.settings.recordingsFolder=n||"Recordings",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Recording"}),new a.Setting(t).setName("Save Audio Files").setDesc("Save the original audio recording alongside the note").addToggle(s=>s.setValue(this.plugin.settings.saveAudioFiles).onChange(async n=>{this.plugin.settings.saveAudioFiles=n,await this.plugin.saveSettings()})),new a.Setting(t).setName("Append Full Transcript").setDesc("Include the full transcript at the end of the structured summary").addToggle(s=>s.setValue(this.plugin.settings.appendTranscript).onChange(async n=>{this.plugin.settings.appendTranscript=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Salesforce Sync"}),new a.Setting(t).setName("Sync on Startup").setDesc("Automatically sync accounts when Obsidian opens").addToggle(s=>s.setValue(this.plugin.settings.syncOnStartup).onChange(async n=>{this.plugin.settings.syncOnStartup=n,await this.plugin.saveSettings()})),new a.Setting(t).setName("Auto-Sync After Transcription").setDesc("Automatically sync meeting notes to Salesforce after transcription").addToggle(s=>s.setValue(this.plugin.settings.autoSyncAfterTranscription).onChange(async n=>{this.plugin.settings.autoSyncAfterTranscription=n,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Status"}),this.plugin.settings.lastSyncTime){let s=new Date(this.plugin.settings.lastSyncTime);t.createEl("p",{text:`Last synced: ${s.toLocaleString()}`,cls:"setting-item-description"})}t.createEl("p",{text:`Cached accounts: ${this.plugin.settings.cachedAccounts.length}`,cls:"setting-item-description"});let e=p.isSupported();t.createEl("p",{text:`Audio recording: ${e?"\u2713 Supported":"\u2717 Not supported"}`,cls:"setting-item-description"}),t.createEl("h3",{text:"Actions"}),new a.Setting(t).setName("Sync Accounts").setDesc("Manually sync Salesforce accounts and create folders").addButton(s=>s.setButtonText("Sync Now").setCta().onClick(async()=>{await this.plugin.syncAccounts(),this.display()})),new a.Setting(t).setName("Sync Current Note").setDesc("Push the current note's data to Salesforce").addButton(s=>s.setButtonText("Sync to Salesforce").onClick(async()=>{await this.plugin.syncNoteToSalesforce()})),new a.Setting(t).setName("Fetch Context").setDesc("Get pre-call context for the current note").addButton(s=>s.setButtonText("Fetch Context").onClick(async()=>{await this.plugin.fetchAndInsertContext()}))}};
