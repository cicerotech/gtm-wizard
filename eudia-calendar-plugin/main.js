var E=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var j=(d,u)=>{for(var e in u)E(d,e,{get:u[e],enumerable:!0})},R=(d,u,e,t)=>{if(u&&typeof u=="object"||typeof u=="function")for(let n of M(u))!O.call(d,n)&&n!==e&&E(d,n,{get:()=>u[n],enumerable:!(t=I(u,n))||t.enumerable});return d};var B=d=>R(E({},"__esModule",{value:!0}),d);var U={};j(U,{default:()=>w});module.exports=B(U);var o=require("obsidian"),D="[Eudia Calendar]";function r(d,...u){console.log(`${D} ${d}`,...u)}function y(d,u){console.error(`${D} ERROR: ${d}`,u||"")}function T(d){console.warn(`${D} WARN: ${d}`)}var P={userEmail:"",serverUrl:"https://gtm-wizard.onrender.com",refreshMinutes:5,accountsFolder:"Accounts"},p="eudia-calendar-standalone",$=class extends o.ItemView{constructor(e,t){super(e);this.refreshTimer=null;this.plugin=t}getViewType(){return p}getDisplayText(){return"Calendar"}getIcon(){return"calendar"}async onOpen(){await this.render();let e=(this.plugin.settings.refreshMinutes||5)*60*1e3;this.refreshTimer=window.setInterval(()=>this.render(),e)}async onClose(){this.refreshTimer&&window.clearInterval(this.refreshTimer)}async render(){let e=this.containerEl.children[1];e.empty(),e.addClass("eudia-cal-container");let t=e.createDiv({cls:"eudia-cal-header"});t.createEl("h4",{text:"Upcoming Meetings"});let n=t.createEl("button",{cls:"eudia-cal-refresh",text:"\u21BB"});if(n.title="Refresh",n.onclick=()=>this.render(),!this.plugin.settings.userEmail){this.renderEmailSetup(e);return}let a=e.createDiv({cls:"eudia-cal-loading"});a.innerHTML='<div class="eudia-cal-spinner"></div>';try{let s=await this.fetchMeetings();if(a.remove(),!s.success){this.renderError(e,s.error||"Failed to load calendar");return}if(s.totalMeetings===0){e.createDiv({cls:"eudia-cal-empty",text:"No upcoming meetings this week"});return}let l=Object.keys(s.byDay).sort();for(let h of l){let g=s.byDay[h];if(!g||g.length===0)continue;let m=e.createDiv({cls:"eudia-cal-day"});m.createEl("div",{cls:"eudia-cal-day-header",text:this.formatDayName(h)});for(let c of g){let i=m.createDiv({cls:`eudia-cal-meeting ${c.isCustomerMeeting?"customer":""}`});i.createEl("div",{cls:"eudia-cal-time",text:this.formatTime(c.start)});let f=i.createDiv({cls:"eudia-cal-details"});if(f.createEl("div",{cls:"eudia-cal-subject",text:c.subject}),c.accountName&&f.createEl("div",{cls:"eudia-cal-account",text:c.accountName}),c.attendees&&c.attendees.length>0){let C=f.createDiv({cls:"eudia-cal-attendee-chips"}),v=3;for(let S=0;S<Math.min(c.attendees.length,v);S++){let b=c.attendees[S],F=b.name||b.email.split("@")[0],N=F.split(" ").map(L=>L[0]).join("").substring(0,2).toUpperCase(),A=C.createEl("span",{cls:"eudia-cal-chip",text:N});A.title=`${F} (${b.email})`}c.attendees.length>v&&C.createEl("span",{cls:"eudia-cal-chip more",text:`+${c.attendees.length-v}`});let k=`${c.attendees.length} external`;C.createEl("span",{cls:"eudia-cal-attendee-count",text:k})}i.title="Click to create note",i.onclick=()=>this.createNoteForMeeting(c)}}}catch(s){a.remove(),this.renderError(e,s.message||"Connection failed")}}async fetchMeetings(){let{serverUrl:e,userEmail:t}=this.plugin.settings;r(`Fetching meetings for ${t} from ${e}`);try{try{(await(0,o.requestUrl)({url:`${e}/api/health`,method:"GET",throw:!1})).status!==200&&T("Server health check failed")}catch(s){T("Server may be starting up...")}let n=await(0,o.requestUrl)({url:`${e}/api/calendar/${encodeURIComponent(t)}/week`,method:"GET",headers:{Accept:"application/json"},throw:!1});if(r(`Calendar API response status: ${n.status}`),n.status===403)return{success:!1,totalMeetings:0,byDay:{},error:"Email not authorized. Please use your @eudia.com email address."};if(n.status!==200)return{success:!1,totalMeetings:0,byDay:{},error:`Server returned ${n.status}. Please try again.`};let a=n.json;return r(`Received ${a.totalMeetings||0} meetings`),a}catch(n){return y("Failed to fetch meetings:",n),{success:!1,totalMeetings:0,byDay:{},error:n.message||"Network error. Check your connection."}}}renderEmailSetup(e){let t=e.createDiv({cls:"eudia-cal-setup"});t.createEl("h4",{text:"Connect Your Calendar"}),t.createEl("p",{text:"Enter your work email to see your meetings:"});let n=t.createDiv({cls:"eudia-cal-form"}),a=n.createEl("input",{type:"email",placeholder:"you@company.com"});a.addClass("eudia-cal-input");let s=n.createEl("button",{text:"Connect",cls:"eudia-cal-btn"});s.onclick=async()=>{let l=a.value.trim();if(!l||!l.includes("@")){new o.Notice("Please enter a valid email");return}s.innerHTML='<span class="eudia-cal-btn-spinner"></span>',s.setAttribute("disabled","true");try{let h=`${this.plugin.settings.serverUrl}/api/calendar/${l}/week`;(await(0,o.requestUrl)({url:h,method:"GET"})).json.success!==!1?(this.plugin.settings.userEmail=l,await this.plugin.saveSettings(),new o.Notice("\u2713 Calendar connected!"),await this.render()):(new o.Notice("Could not connect. Check your email."),s.textContent="Connect",s.removeAttribute("disabled"))}catch(h){new o.Notice("Connection failed. Try again."),s.textContent="Connect",s.removeAttribute("disabled")}}}renderError(e,t){let n=e.createDiv({cls:"eudia-cal-error"});n.createEl("p",{text:`Error: ${t}`});let a=n.createEl("button",{text:"Retry",cls:"eudia-cal-btn"});a.onclick=()=>this.render()}extractAccountFromAttendees(e){if(!e||e.length===0)return null;let t=["gmail.com","outlook.com","hotmail.com","yahoo.com","icloud.com","live.com","msn.com","aol.com","protonmail.com"],n=[];for(let h of e){if(!h.email)continue;let m=h.email.toLowerCase().match(/@([a-z0-9.-]+)/);if(m){let c=m[1];!c.includes("eudia.com")&&!t.includes(c)&&n.push(c)}}if(n.length===0)return null;let a=n[0],s=a.split(".")[0],l=s.charAt(0).toUpperCase()+s.slice(1);return r(`Extracted company "${l}" from attendee domain ${a}`),l}extractAccountFromSubject(e){if(!e)return null;let t=e.match(/^([^\/]+)\s*\/\s*Eudia|Eudia\s*\/\s*([^\/\-|]+)/i);if(t){let a=(t[1]||t[2]||"").trim();if(a.toLowerCase()!=="eudia")return a}let n=e.match(/^Eudia\s*[-–]\s*([^|]+)|^([^-–]+)\s*[-–]\s*Eudia/i);if(n){let s=(n[1]||n[2]||"").trim().replace(/\s+(Connect|Weekly|Call|Meeting|Intro|Demo|Check\s*in|Sync).*$/i,"").trim();if(s.toLowerCase()!=="eudia"&&s.length>0)return s}if(!e.toLowerCase().includes("eudia")){let a=e.match(/^([^-–|]+)/);if(a){let s=a[1].trim();if(s.length>2&&s.length<50)return s}}return null}findAccountFolder(e){if(!e)return null;let t=this.plugin.settings.accountsFolder||"Accounts",n=this.app.vault.getAbstractFileByPath(t);if(!(n instanceof o.TFolder))return r(`Accounts folder "${t}" not found`),null;let a=e.toLowerCase().trim(),s=[];for(let i of n.children)i instanceof o.TFolder&&s.push(i.name);r(`Searching for "${a}" in ${s.length} folders`);let l=s.find(i=>i.toLowerCase()===a);if(l)return r(`Exact match found: ${l}`),`${t}/${l}`;let h=s.find(i=>i.toLowerCase().startsWith(a));if(h)return r(`Folder starts with match: ${h}`),`${t}/${h}`;let g=s.find(i=>a.startsWith(i.toLowerCase()));if(g)return r(`Search starts with folder match: ${g}`),`${t}/${g}`;let m=s.find(i=>{let f=i.toLowerCase();return f.length>=3&&a.includes(f)});if(m)return r(`Search contains folder match: ${m}`),`${t}/${m}`;let c=s.find(i=>{let f=i.toLowerCase();return a.length>=3&&f.includes(a)});return c?(r(`Folder contains search match: ${c}`),`${t}/${c}`):(r(`No folder match found for "${a}"`),null)}async createNoteForMeeting(e){let t=e.start.split("T")[0],n=e.subject.replace(/[<>:"/\\|?*]/g,"_").substring(0,50),a=`${t} - ${n}.md`,s=null,l=e.accountName;if(r(`=== Creating note for meeting: "${e.subject}" ===`),r(`Attendees: ${JSON.stringify(e.attendees.map(i=>i.email))}`),!s&&e.attendees&&e.attendees.length>0){let i=this.extractAccountFromAttendees(e.attendees);r(`Extracted domain company name: "${i||"none"}"`),i&&(s=this.findAccountFolder(i),r(`Domain-based "${i}" -> folder: ${s||"not found"}`),s&&!l&&(l=i))}if(!s&&l&&(s=this.findAccountFolder(l),r(`Server accountName "${l}" -> folder: ${s||"not found"}`)),!s){let i=this.extractAccountFromSubject(e.subject);i&&(s=this.findAccountFolder(i),r(`Subject-based "${i}" -> folder: ${s||"not found"}`),s&&!l&&(l=i))}if(!s){let i=this.plugin.settings.accountsFolder||"Accounts";this.app.vault.getAbstractFileByPath(i)instanceof o.TFolder&&(s=i,r(`No match found, using Accounts root: ${s}`))}let h=s?`${s}/${a}`:a,g=this.app.vault.getAbstractFileByPath(h);if(g instanceof o.TFile){await this.app.workspace.getLeaf().openFile(g),new o.Notice(`Opened existing note: ${a}`);return}let m=e.attendees.map(i=>`- ${i.name||i.email}`).join(`
`),c=`---
title: "${e.subject}"
date: ${t}
meeting_time: ${this.formatTime(e.start)}
attendees: ${e.attendees.map(i=>i.name||i.email).join(", ")}
account: "${l||"TBD"}"
clo_meeting: false
source: ""
sync_to_salesforce: false
---

# ${e.subject}

## Attendees
${m}

## Notes


## Next Steps
- [ ] 

`;try{s&&(this.app.vault.getAbstractFileByPath(s)||await this.app.vault.createFolder(s));let i=await this.app.vault.create(h,c);await this.app.workspace.getLeaf().openFile(i),new o.Notice(`Created: ${h}`)}catch(i){y("Failed to create note:",i),new o.Notice(`Could not create note: ${i.message||"Unknown error"}`)}}formatDayName(e){let t=new Date(e),n=new Date;n.setHours(0,0,0,0);let a=new Date(t);a.setHours(0,0,0,0);let s=(a.getTime()-n.getTime())/(1e3*60*60*24);return s===0?"Today":s===1?"Tomorrow":t.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})}formatTime(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}},x=class extends o.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Eudia Calendar"}),new o.Setting(e).setName("Your Email").setDesc("Your work email (e.g., keigan@eudia.com)").addText(t=>t.setPlaceholder("you@company.com").setValue(this.plugin.settings.userEmail).onChange(async n=>{this.plugin.settings.userEmail=n,await this.plugin.saveSettings()})),new o.Setting(e).setName("Refresh Interval").setDesc("How often to refresh (minutes)").addSlider(t=>t.setLimits(1,30,1).setValue(this.plugin.settings.refreshMinutes).setDynamicTooltip().onChange(async n=>{this.plugin.settings.refreshMinutes=n,await this.plugin.saveSettings()})),new o.Setting(e).setName("Accounts Folder").setDesc("Folder containing account subfolders (default: Accounts)").addText(t=>t.setPlaceholder("Accounts").setValue(this.plugin.settings.accountsFolder).onChange(async n=>{this.plugin.settings.accountsFolder=n||"Accounts",await this.plugin.saveSettings()})),new o.Setting(e).setName("Test Connection").setDesc("Verify calendar is working").addButton(t=>t.setButtonText("Test").setCta().onClick(async()=>{if(!this.plugin.settings.userEmail){new o.Notice("Enter your email first");return}t.setButtonText("Testing...");try{let n=`${this.plugin.settings.serverUrl}/api/calendar/${this.plugin.settings.userEmail}/week`,a=await(0,o.requestUrl)({url:n,method:"GET"});a.json.success?(new o.Notice(`Connected! ${a.json.totalMeetings} meetings this week`),t.setButtonText("Success")):(new o.Notice(`Error: ${a.json.error}`),t.setButtonText("Failed"))}catch(n){new o.Notice("Connection failed"),t.setButtonText("Failed")}setTimeout(()=>t.setButtonText("Test"),2e3)})),new o.Setting(e).setName("Sync Calendar").setDesc("Refresh calendar data from Microsoft 365").addButton(t=>t.setButtonText("Sync Now").onClick(async()=>{t.setButtonText("Syncing...");try{let n=`${this.plugin.settings.serverUrl}/api/calendar/sync/trigger`,a=await(0,o.requestUrl)({url:n,method:"POST"});a.json.success?(new o.Notice("Calendar sync started. Data will refresh in a few moments."),t.setButtonText("Started")):(new o.Notice(`Sync failed: ${a.json.error}`),t.setButtonText("Failed"))}catch(n){new o.Notice("Failed to start sync"),t.setButtonText("Failed")}setTimeout(()=>t.setButtonText("Sync Now"),2e3)}))}},w=class extends o.Plugin{async onload(){r("Plugin loading..."),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:onload",message:"Plugin onload START",data:{timestamp:new Date().toISOString()},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H2"})}).catch(()=>{});try{await this.loadSettings(),r("Settings loaded:",{hasEmail:!!this.settings.userEmail,serverUrl:this.settings.serverUrl}),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:afterSettings",message:"Settings loaded successfully",data:{settings:this.settings},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H4"})}).catch(()=>{}),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:beforeRegisterView",message:"About to register view",data:{viewType:p},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H5"})}).catch(()=>{}),this.registerView(p,e=>(r("Creating EudiaCalendarView"),new $(e,this))),r("View registered with type:",p),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:afterRegisterView",message:"View registered successfully",data:{viewType:p},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H5"})}).catch(()=>{}),this.addRibbonIcon("calendar","Eudia Calendar",()=>{r("Ribbon icon clicked"),this.openCalendar()}),r("Ribbon icon added"),this.addCommand({id:"open-calendar",name:"Open Calendar",callback:()=>this.openCalendar()}),r("Command registered"),this.addSettingTab(new x(this.app,this)),r("Settings tab added"),this.settings.userEmail&&this.app.workspace.onLayoutReady(()=>{r("Workspace ready, auto-opening calendar"),this.openCalendar()}),r("Plugin loaded successfully!"),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:loadComplete",message:"Plugin loaded SUCCESSFULLY",data:{success:!0},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H2"})}).catch(()=>{})}catch(e){y("Failed to load plugin:",e),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:loadFailed",message:"Plugin load FAILED",data:{error:String(e),stack:e==null?void 0:e.stack},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H2"})}).catch(()=>{}),new o.Notice("Eudia Calendar: Failed to load. Check console for details.")}}async loadSettings(){fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:loadSettingsStart",message:"loadSettings called",data:{},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H4"})}).catch(()=>{});try{let e=await this.loadData();fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:loadDataResult",message:"loadData returned",data:{rawData:e,type:typeof e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H4"})}).catch(()=>{}),this.settings=Object.assign({},P,e||{}),r("Settings merged:",Object.keys(this.settings))}catch(e){y("Failed to load settings, using defaults:",e),fetch("http://127.0.0.1:7242/ingest/6cbaf1f9-0647-49b0-8811-5ad970525e48",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"eudia-calendar/main.ts:loadSettingsError",message:"loadSettings FAILED",data:{error:String(e)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"H4"})}).catch(()=>{}),this.settings={...P}}}async saveSettings(){try{await this.saveData(this.settings),r("Settings saved")}catch(e){y("Failed to save settings:",e),new o.Notice("Failed to save calendar settings")}}async openCalendar(){r("Opening calendar view...");try{let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(r("Existing leaf found:",!!t),!t){let n=e.getRightLeaf(!1);n?(r("Creating new view in right leaf"),await n.setViewState({type:p,active:!0}),t=n):T("Could not get right leaf")}t?(e.revealLeaf(t),r("Calendar view revealed")):y("No leaf available for calendar view")}catch(e){y("Failed to open calendar:",e),new o.Notice("Could not open calendar view")}}onunload(){r("Plugin unloading...")}};
