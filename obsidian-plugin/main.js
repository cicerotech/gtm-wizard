var o=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var p=(c,t)=>{for(var e in t)o(c,e,{get:t[e],enumerable:!0})},S=(c,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of h(t))!y.call(c,a)&&a!==e&&o(c,a,{get:()=>t[a],enumerable:!(n=d(t,a))||n.enumerable});return c};var f=c=>S(o({},"__esModule",{value:!0}),c);var m={};p(m,{default:()=>i});module.exports=f(m);var s=require("obsidian"),w={serverUrl:"https://gtm-brain.onrender.com",accountsFolder:"Accounts",syncOnStartup:!0,lastSyncTime:null},i=class extends s.Plugin{async onload(){await this.loadSettings(),this.addRibbonIcon("refresh-cw","Sync Salesforce Accounts",async()=>{await this.syncAccounts()}),this.addCommand({id:"sync-salesforce-accounts",name:"Sync Salesforce Accounts",callback:async()=>{await this.syncAccounts()}}),this.addSettingTab(new r(this.app,this)),this.settings.syncOnStartup&&setTimeout(()=>{this.syncAccounts(!0)},2e3)}async loadSettings(){this.settings=Object.assign({},w,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async syncAccounts(t=!1){try{t||new s.Notice("Syncing Salesforce accounts...");let e=await this.fetchAccounts();if(e.length===0){t||new s.Notice("No accounts found or server unavailable");return}await this.ensureFolderExists(this.settings.accountsFolder);let n=this.getExistingAccountFolders(),a=0;for(let u of e){let l=this.sanitizeFolderName(u.name),g=`${this.settings.accountsFolder}/${l}`;n.includes(l.toLowerCase())||(await this.ensureFolderExists(g),a++)}this.settings.lastSyncTime=new Date().toISOString(),await this.saveSettings(),t||(a>0?new s.Notice(`Sync complete! Created ${a} new account folders`):new s.Notice(`Sync complete. All ${e.length} accounts already have folders.`))}catch(e){console.error("Eudia Sync error:",e),t||new s.Notice(`Sync failed: ${e.message}`)}}async fetchAccounts(){try{let e=(await(0,s.requestUrl)({url:`${this.settings.serverUrl}/api/accounts/obsidian`,method:"GET",headers:{Accept:"application/json"}})).json;if(!e.success)throw new Error("API returned unsuccessful response");return e.accounts||[]}catch(t){throw console.error("Failed to fetch accounts:",t),new Error("Could not connect to GTM Brain server")}}getExistingAccountFolders(){let t=this.app.vault.getAbstractFileByPath(this.settings.accountsFolder);return!t||!(t instanceof s.TFolder)?[]:t.children.filter(e=>e instanceof s.TFolder).map(e=>e.name.toLowerCase())}async ensureFolderExists(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t)}sanitizeFolderName(t){return t.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g," ").trim()}},r=class extends s.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Eudia Sync Settings"}),new s.Setting(t).setName("GTM Brain Server URL").setDesc("The URL of your GTM Brain server").addText(e=>e.setPlaceholder("https://gtm-brain.onrender.com").setValue(this.plugin.settings.serverUrl).onChange(async n=>{this.plugin.settings.serverUrl=n,await this.plugin.saveSettings()})),new s.Setting(t).setName("Accounts Folder").setDesc("Folder where account subfolders will be created").addText(e=>e.setPlaceholder("Accounts").setValue(this.plugin.settings.accountsFolder).onChange(async n=>{this.plugin.settings.accountsFolder=n||"Accounts",await this.plugin.saveSettings()})),new s.Setting(t).setName("Sync on Startup").setDesc("Automatically sync accounts when Obsidian opens").addToggle(e=>e.setValue(this.plugin.settings.syncOnStartup).onChange(async n=>{this.plugin.settings.syncOnStartup=n,await this.plugin.saveSettings()})),this.plugin.settings.lastSyncTime){let e=new Date(this.plugin.settings.lastSyncTime);t.createEl("p",{text:`Last synced: ${e.toLocaleString()}`,cls:"setting-item-description"})}new s.Setting(t).setName("Sync Now").setDesc("Manually sync Salesforce accounts").addButton(e=>e.setButtonText("Sync Accounts").setCta().onClick(async()=>{await this.plugin.syncAccounts()}))}};
