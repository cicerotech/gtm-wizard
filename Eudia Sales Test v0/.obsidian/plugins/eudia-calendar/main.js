var D=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var U=(i,r)=>{for(var e in r)D(i,e,{get:r[e],enumerable:!0})},V=(i,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of k(r))!R.call(i,n)&&n!==e&&D(i,n,{get:()=>r[n],enumerable:!(t=A(r,n))||t.enumerable});return i};var F=i=>V(D({},"__esModule",{value:!0}),i);var W={};U(W,{default:()=>E});module.exports=F(W);var p=require("obsidian");var I=require("obsidian"),f="eudia-calendar-view",C=class extends I.ItemView{constructor(e,t){super(e);this.refreshInterval=null;this.plugin=t}getViewType(){return f}getDisplayText(){return"Eudia Calendar"}getIcon(){return"calendar"}async onOpen(){this.render(),this.refreshInterval=window.setInterval(()=>{this.plugin.refreshCalendar().then(()=>this.render())},5*60*1e3)}async onClose(){this.refreshInterval&&window.clearInterval(this.refreshInterval)}render(){let e=this.containerEl.children[1];e.empty(),e.addClass("eudia-calendar-container");let t=e.createDiv({cls:"eudia-calendar-header"});t.createEl("h3",{text:"Calendar"});let n=t.createEl("button",{cls:"eudia-calendar-refresh",text:"\u21BB"});if(n.title="Refresh calendar",n.onclick=async()=>{n.disabled=!0,n.textContent="...",await this.plugin.refreshCalendar(),this.render()},!this.plugin.settings.icsUrl){this.renderSetupMessage(e);return}if(this.plugin.isLoading){e.createDiv({cls:"eudia-calendar-loading",text:"Loading calendar..."});return}if(this.plugin.lastError){let a=e.createDiv({cls:"eudia-calendar-error"});a.createEl("p",{text:"\u26A0\uFE0F "+this.plugin.lastError}),a.createEl("button",{text:"Retry"}).onclick=async()=>{await this.plugin.refreshCalendar(),this.render()};return}this.renderDateNavigator(e),this.renderEventList(e)}renderSetupMessage(e){let t=e.createDiv({cls:"eudia-calendar-setup"});t.createEl("h4",{text:"Setup Required"}),t.createEl("p",{text:"Add your calendar ICS URL in settings."});let n=t.createDiv({cls:"eudia-calendar-instructions"});n.createEl("h5",{text:"To get your ICS URL:"});let a=n.createEl("ol");a.createEl("li",{text:"Microsoft 365: Outlook \u2192 Settings \u2192 Calendar \u2192 Shared calendars \u2192 Publish a calendar"}),a.createEl("li",{text:"Google: Calendar \u2192 Settings \u2192 Integrate calendar \u2192 Secret address in iCal format"}),a.createEl("li",{text:"Copy the ICS link and paste it in plugin settings"}),t.createEl("button",{text:"Open Settings"}).onclick=()=>{this.app.setting.open(),this.app.setting.openTabById("eudia-calendar")}}renderDateNavigator(e){let t=e.createDiv({cls:"eudia-calendar-nav"}),n=["Today","This Week","Upcoming"],a=this.plugin.settings.defaultView||"Today";for(let s of n){let o=t.createEl("button",{text:s,cls:`eudia-nav-btn ${s===a?"active":""}`});o.onclick=()=>{this.plugin.settings.defaultView=s,this.plugin.saveSettings(),this.render()}}}renderEventList(e){let t=this.getFilteredEvents(),n=e.createDiv({cls:"eudia-calendar-events"});if(t.length===0){n.createDiv({cls:"eudia-no-events",text:"No meetings scheduled"});return}let a=this.groupEventsByDate(t);for(let[s,o]of Object.entries(a)){n.createDiv({cls:"eudia-date-header"}).createEl("span",{text:this.formatDateHeader(s)});for(let c of o)this.renderEventCard(n,c)}}renderEventCard(e,t){let n=e.createDiv({cls:`eudia-event-card ${t.status==="cancelled"?"cancelled":""}`}),a=n.createDiv({cls:"eudia-event-time"});t.allDay?a.textContent="All day":a.textContent=this.formatTime(t.start)+" - "+this.formatTime(t.end);let s=n.createDiv({cls:"eudia-event-title"});if(s.textContent=t.title,t.location){let l=n.createDiv({cls:"eudia-event-location"});l.textContent="\u{1F4CD} "+t.location}if(t.attendees.length>0){let l=n.createDiv({cls:"eudia-event-attendees"}),c=l.createEl("span",{cls:"eudia-attendees-toggle",text:`\u{1F465} ${t.attendees.length} attendees`}),g=l.createDiv({cls:"eudia-attendees-list hidden"});for(let d of t.attendees.slice(0,10)){let m=d.status==="accepted"?"\u2713":d.status==="declined"?"\u2717":d.status==="tentative"?"?":"\xB7";g.createDiv({text:`${m} ${d.name||d.email}`})}t.attendees.length>10&&g.createDiv({text:`... and ${t.attendees.length-10} more`}),c.onclick=()=>{g.toggleClass("hidden",!g.hasClass("hidden"))}}let o=n.createEl("button",{cls:"eudia-create-note-btn",text:"+ Create Note"});o.onclick=()=>this.plugin.createNoteFromEvent(t)}getFilteredEvents(){let e=this.plugin.settings.defaultView||"Today",t=this.plugin.events,n=new Date;switch(e){case"Today":{let a=new Date(n);a.setHours(0,0,0,0);let s=new Date(a);return s.setDate(s.getDate()+1),t.filter(o=>o.start>=a&&o.start<s)}case"This Week":{let a=new Date(n);a.setHours(0,0,0,0),a.setDate(n.getDate()-n.getDay());let s=new Date(a);return s.setDate(s.getDate()+7),t.filter(o=>o.start>=a&&o.start<s)}case"Upcoming":default:{let a=new Date(n);return a.setDate(a.getDate()+14),t.filter(s=>s.start>=n&&s.start<a)}}}groupEventsByDate(e){let t={};for(let n of e){let a=n.start.toISOString().split("T")[0];t[a]||(t[a]=[]),t[a].push(n)}return t}formatDateHeader(e){let t=new Date(e+"T00:00:00"),n=new Date;n.setHours(0,0,0,0);let a=new Date(n);return a.setDate(a.getDate()+1),t.getTime()===n.getTime()?"Today":t.getTime()===a.getTime()?"Tomorrow":t.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})}formatTime(e){return e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}};function N(i){let r=[],e=i.split("BEGIN:VEVENT");for(let t=1;t<e.length;t++){let n=e[t].split("END:VEVENT")[0];try{let a=O(n);a&&r.push(a)}catch(a){console.warn("Failed to parse calendar event:",a)}}return r.sort((t,n)=>t.start.getTime()-n.start.getTime()),r}function O(i){let r=P(i),e=u=>{for(let v of r)if(v.startsWith(u+":")||v.startsWith(u+";")){let x=v.indexOf(":");return x>0?v.substring(x+1).trim():""}return""},t=e("UID"),n=y(e("SUMMARY")),a=y(e("DESCRIPTION")),s=y(e("LOCATION")),o=L(r,"DTSTART"),l=L(r,"DTEND");if(!o)return null;let c=r.some(u=>u.includes("DTSTART;VALUE=DATE:")||u.startsWith("DTSTART:")&&u.length===17),g=B(r),d=r.find(u=>u.startsWith("ORGANIZER")),m="";if(d){let u=d.match(/CN=([^;:]+)/);m=u?u[1].replace(/"/g,""):""}let S=e("STATUS").toLowerCase(),T="confirmed";return S==="tentative"&&(T="tentative"),S==="cancelled"&&(T="cancelled"),{uid:t,title:n||"(No title)",description:a,location:s,start:o,end:l||new Date(o.getTime()+60*60*1e3),allDay:c,organizer:m,attendees:g,status:T,raw:i}}function P(i){return i.replace(/\r?\n[ \t]/g,"").split(/\r?\n/).filter(e=>e.trim())}function L(i,r){for(let e of i){if(!e.startsWith(r))continue;let t=e.indexOf(":");if(t<0)continue;let n=e.substring(t+1).trim(),a=e.match(/TZID=([^:;]+)/);if(n.includes("T"))return M(n,a==null?void 0:a[1]);if(n.length===8){let s=parseInt(n.substring(0,4)),o=parseInt(n.substring(4,6))-1,l=parseInt(n.substring(6,8));return new Date(s,o,l)}}return null}function M(i,r){let e=parseInt(i.substring(0,4)),t=parseInt(i.substring(4,6))-1,n=parseInt(i.substring(6,8)),a=parseInt(i.substring(9,11)),s=parseInt(i.substring(11,13)),o=parseInt(i.substring(13,15))||0;return i.endsWith("Z")?new Date(Date.UTC(e,t,n,a,s,o)):new Date(e,t,n,a,s,o)}function B(i){let r=[];for(let e of i){if(!e.startsWith("ATTENDEE"))continue;let t=e.match(/CN=([^;:]+)/),n=t?t[1].replace(/"/g,""):"",a=e.match(/mailto:([^>\s]+)/i),s=a?a[1]:"",o=e.match(/PARTSTAT=([^;:]+)/),l="needs-action";if(o){let d=o[1].toLowerCase();d==="accepted"?l="accepted":d==="declined"?l="declined":d==="tentative"&&(l="tentative")}let c=e.match(/ROLE=([^;:]+)/),g="required";if(c){let d=c[1].toLowerCase();d==="opt-participant"?g="optional":d==="chair"&&(g="chair")}(n||s)&&r.push({name:n,email:s,status:l,role:g})}return r}function y(i){return i.replace(/\\n/g,`
`).replace(/\\,/g,",").replace(/\\;/g,";").replace(/\\\\/g,"\\")}var h=require("obsidian"),b={icsUrl:"",refreshInterval:5,defaultView:"Today",notesFolder:"Meetings",noteTemplate:`---
meeting_date: {{date}}
meeting_time: {{time}}
attendees: {{attendees}}
location: {{location}}
synced_to_salesforce: false
---

# {{title}}

## Attendees
{{attendee_list}}

## Notes


## Action Items
- [ ] 

## Next Steps
- [ ] 
`,showCancelled:!1,autoCreateNotes:!1,autoCreateMinutesBefore:5},w=class extends h.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Eudia Calendar Settings"}),new h.Setting(e).setName("Calendar ICS URL").setDesc("Your calendar's ICS/iCal URL. Get this from Microsoft 365 or Google Calendar.").addText(n=>n.setPlaceholder("https://outlook.office365.com/owa/calendar/...").setValue(this.plugin.settings.icsUrl).onChange(async a=>{this.plugin.settings.icsUrl=a,await this.plugin.saveSettings()}));let t=e.createDiv({cls:"setting-item-description"});t.style.marginTop="-10px",t.style.marginBottom="15px",t.innerHTML=`
      <details>
        <summary>How to get your ICS URL</summary>
        <p><strong>Microsoft 365:</strong></p>
        <ol>
          <li>Go to <a href="https://outlook.office365.com/calendar">Outlook Calendar</a></li>
          <li>Settings (gear icon) \u2192 View all Outlook settings</li>
          <li>Calendar \u2192 Shared calendars</li>
          <li>Under "Publish a calendar", select your calendar</li>
          <li>Choose "Can view all details" and click "Publish"</li>
          <li>Copy the ICS link</li>
        </ol>
        <p><strong>Google Calendar:</strong></p>
        <ol>
          <li>Go to <a href="https://calendar.google.com/calendar/r/settings">Google Calendar Settings</a></li>
          <li>Click on your calendar under "Settings for my calendars"</li>
          <li>Scroll to "Integrate calendar"</li>
          <li>Copy "Secret address in iCal format"</li>
        </ol>
      </details>
    `,new h.Setting(e).setName("Refresh interval").setDesc("How often to refresh the calendar (in minutes)").addSlider(n=>n.setLimits(1,60,1).setValue(this.plugin.settings.refreshInterval).setDynamicTooltip().onChange(async a=>{this.plugin.settings.refreshInterval=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Default view").setDesc("Which view to show when opening the calendar").addDropdown(n=>n.addOption("Today","Today").addOption("This Week","This Week").addOption("Upcoming","Upcoming (14 days)").setValue(this.plugin.settings.defaultView).onChange(async a=>{this.plugin.settings.defaultView=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Meeting notes folder").setDesc("Where to create meeting notes").addText(n=>n.setPlaceholder("Meetings").setValue(this.plugin.settings.notesFolder).onChange(async a=>{this.plugin.settings.notesFolder=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Show cancelled events").setDesc("Include cancelled meetings in the calendar view").addToggle(n=>n.setValue(this.plugin.settings.showCancelled).onChange(async a=>{this.plugin.settings.showCancelled=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Note Template"}),e.createEl("p",{text:"Template for new meeting notes. Available variables: {{title}}, {{date}}, {{time}}, {{location}}, {{attendees}}, {{attendee_list}}, {{description}}",cls:"setting-item-description"}),new h.Setting(e).setName("Note template").addTextArea(n=>{n.setPlaceholder("Enter your template...").setValue(this.plugin.settings.noteTemplate).onChange(async a=>{this.plugin.settings.noteTemplate=a,await this.plugin.saveSettings()}),n.inputEl.rows=15,n.inputEl.cols=60}),e.createEl("h3",{text:"Test Connection"}),new h.Setting(e).setName("Test calendar connection").setDesc("Verify your ICS URL is working correctly").addButton(n=>n.setButtonText("Test Connection").setCta().onClick(async()=>{n.setButtonText("Testing..."),n.setDisabled(!0);try{await this.plugin.refreshCalendar();let a=this.plugin.events.length;n.setButtonText(`\u2713 Found ${a} events`)}catch(a){n.setButtonText("\u2717 Failed"),console.error("Calendar test failed:",a)}setTimeout(()=>{n.setButtonText("Test Connection"),n.setDisabled(!1)},3e3)}))}};var E=class extends p.Plugin{constructor(){super(...arguments);this.events=[];this.isLoading=!1;this.lastError=null;this.refreshTimer=null}async onload(){console.log("Loading Eudia Calendar plugin"),await this.loadSettings(),this.registerView(f,e=>new C(e,this)),this.addRibbonIcon("calendar","Eudia Calendar",()=>{this.activateView()}),this.addCommand({id:"open-calendar",name:"Open Calendar",callback:()=>this.activateView()}),this.addCommand({id:"refresh-calendar",name:"Refresh Calendar",callback:async()=>{await this.refreshCalendar(),new p.Notice(`Refreshed: ${this.events.length} events loaded`)}}),this.addCommand({id:"create-note-next-meeting",name:"Create Note for Next Meeting",callback:async()=>{await this.createNoteForNextMeeting()}}),this.addSettingTab(new w(this.app,this)),this.settings.icsUrl&&(this.refreshCalendar(),this.startAutoRefresh())}onunload(){console.log("Unloading Eudia Calendar plugin"),this.stopAutoRefresh()}async loadSettings(){this.settings=Object.assign({},b,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.stopAutoRefresh(),this.startAutoRefresh()}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(f)[0];if(!t){let n=e.getRightLeaf(!1);n&&(await n.setViewState({type:f,active:!0}),t=n)}t&&e.revealLeaf(t)}async refreshCalendar(){if(!this.settings.icsUrl){this.lastError="No ICS URL configured";return}this.isLoading=!0,this.lastError=null;try{let e=await(0,p.requestUrl)({url:this.settings.icsUrl,method:"GET",headers:{Accept:"text/calendar, application/calendar+xml, text/plain"}});if(!e.text)throw new Error("Empty response from calendar server");this.events=N(e.text),this.settings.showCancelled||(this.events=this.events.filter(t=>t.status!=="cancelled")),console.log(`Loaded ${this.events.length} calendar events`),this.lastError=null}catch(e){console.error("Failed to refresh calendar:",e),this.lastError=this.getErrorMessage(e),this.events=[]}finally{this.isLoading=!1,this.updateView()}}getErrorMessage(e){let t=e.message||String(e);return t.includes("CORS")||t.includes("NetworkError")?"Calendar blocked by CORS. Try using a different ICS URL or a CORS proxy.":t.includes("401")||t.includes("403")?"Access denied. Check your ICS URL permissions.":t.includes("404")?"Calendar not found. Check your ICS URL.":t.includes("timeout")?"Request timed out. Try again later.":`Failed to load calendar: ${t}`}updateView(){let e=this.app.workspace.getLeavesOfType(f);for(let t of e){let n=t.view;n&&n.render&&n.render()}}startAutoRefresh(){this.settings.refreshInterval>0&&this.settings.icsUrl&&(this.refreshTimer=window.setInterval(()=>this.refreshCalendar(),this.settings.refreshInterval*60*1e3))}stopAutoRefresh(){this.refreshTimer&&(window.clearInterval(this.refreshTimer),this.refreshTimer=null)}async createNoteFromEvent(e){try{let t=this.settings.notesFolder;this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t);let n=e.start.toISOString().split("T")[0],a=e.title.replace(/[\\/:*?"<>|]/g,"-").substring(0,50),s=`${t}/${n} - ${a}.md`,o=this.app.vault.getAbstractFileByPath(s);if(o)return new p.Notice("Note already exists. Opening..."),await this.app.workspace.getLeaf().openFile(o),o;let l=this.applyTemplate(e),c=await this.app.vault.create(s,l);return await this.app.workspace.getLeaf().openFile(c),new p.Notice("Meeting note created"),c}catch(t){return console.error("Failed to create meeting note:",t),new p.Notice(`Failed to create note: ${t.message}`),null}}applyTemplate(e){let t=this.settings.noteTemplate,n=e.start.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),a=e.allDay?"All day":`${e.start.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} - ${e.end.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,s=e.attendees.map(c=>c.name||c.email).filter(Boolean),o=s.map(c=>`- ${c}`).join(`
`),l=s.join(", ");return t=t.replace(/\{\{title\}\}/g,e.title).replace(/\{\{date\}\}/g,n).replace(/\{\{time\}\}/g,a).replace(/\{\{location\}\}/g,e.location||"").replace(/\{\{attendees\}\}/g,l).replace(/\{\{attendee_list\}\}/g,o||"- (none)").replace(/\{\{description\}\}/g,e.description||"").replace(/\{\{organizer\}\}/g,e.organizer||""),t}async createNoteForNextMeeting(){this.events.length===0&&await this.refreshCalendar();let e=new Date,t=this.events.find(n=>n.start>e);if(!t){new p.Notice("No upcoming meetings found");return}await this.createNoteFromEvent(t)}};
